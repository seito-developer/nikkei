# リファクタリング
リファクタリングとは、可読性やメンテナンス性を高める目的で、実行結果を変えることなくコードを整理し書き直すことです。  
例えば、実際の現場では限られた時間の中で（特に短いスケジュールしかない場合など）要件を満たすコーディングをする必要性がしばしば発生する場合があります。このような自体には、一旦動作するコードを書いてスケジュールを間に合わせたあとで、今後のためにリファクタリングを行うなどの手段を取ることがあります。

先のJSコードはなるべく読者の皆さんにわかりやすく伝わることを意識して書いたものですが、可読性やメンテナンス性の観点からはいまいちのコードです。
そこでこのセクションではもう少しきれいなコードへとリファクタリングしてみたいと思います。

## fetchHistoryDataを分ける
まず、Cloud Firestoreからのデータの取得・表示を行っている関数`fetchHistoryData`を別ファイルにしたいと思います。  
まず、ルートディレクトリにディレクトリ`my-modules`を作成し、その中に`fetchHistoryData.js`という空のファイルを作成し、関数`fetchHistoryData`を`export`と主に記述します。

```
/daily-report
├── main.js
├── my-modules
  ├── fetch-history-data.js
(以下省略)
```

・fetch-history-data.js
```js
export const fetchHistoryData = async (getDocs, collection, db) => {
    let tags = "";
    
    // reportsコレクションのデータを取得
    const querySnapshot = await getDocs(collection(db, "reports")); 
    
    // データをテーブル表の形式に合わせてHTMLに挿入
    querySnapshot.forEach((doc) => {
      console.log(`${doc.id} => ${doc.data()}`); 
      tags += `<tr><td>${doc.data().date}</td><td>${doc.data().name}</td><td>${doc.data().work}</td><td>${doc.data().comment}</td></tr>`
    });
    document.getElementById("js-history").innerHTML = tags;
};
```

`main.js`ではこれを`import`し、実行します。

```js
...(中略)...

import { fetchHistoryData } from "./my-modules/fetch-history-data";

...(中略)...

if(document.getElementById("js-history")) {
    fetchHistoryData(getDocs, collection, db);
}
```

ファイルを分けることにより、`getDocs, collection, db`などのFirebaseモジュールのメソッドがそのままでは利用できなくなります。  
そこで関数`fetchHistoryData`には引数を設定できるようにし、`main.js`で呼び出す際に`getDocs, collection, db`を渡すことでコレを解決します。

## submitDataを分ける
続いて、Cloud Firestoreへのデータ送信を行う関数`submitData`を別ファイルにしたいと思います。  
先ほど作成したディレクトリ`my-modules`内に`submit-data.js`という空のファイルを作成し、関数`submitData`を`export`と主に記述します。

```
/daily-report
├── main.js
├── my-modules
  ├── fetch-history-data.js
  ├── submit-data.js
(以下省略)
```


・submit-data.js
```js
export const submitData = async (e, addDoc, collection, db) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const docRef = await addDoc(collection(db, "reports"), {
            date: new Date(),
            name: formData.get("name"),
            work: formData.get("work"),
            comment: formData.get("comment")
        });
        console.log("Document written with ID: ", docRef.id);
    } catch (e) {
        console.error("Error adding document: ", e);
    }
}
```

`main.js`ではこれを`import`し、実行します。

```js
...(中略)...

import { submitData } from "./my-modules/submit-data";

...(中略)...

if(document.getElementById("js-form")) {
    document.getElementById("js-form").addEventListener("submit", (e) => submitData(e, addDoc, collection, db));
}
```

こちらでも同様に、関数`submitData`に引数を設定できるようにし、`main.js`で呼び出す際に`addDoc, collection, db`を渡すように変更しました。

## 環境変数の分割
さて、最後に環境変数を設けたいと思います。
環境変数は、コンピュータやアプリケーションが動作する際に使用される __重要な情報を格納するための特殊な変数__ です。（例えばパスワードや認証に必要なキー情報など）

一部の環境変数には、システムやユーザーのセキュリティとプライバシーに関する情報が含まれているため、これらの情報は慎重に管理される必要があります。  
そして今回のケースでいうと`firebaseConfig`はFirebaseとの接続に使うアカウント情報やKeyが含まれているため、保有する値は環境変数として厳重に管理されるべきです。

```js
const firebaseConfig = {
    apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    authDomain: "daily-report-xxxxx.firebaseapp.com",
    projectId: "daily-report-xxxxx",
    storageBucket: "daily-report-xxxxx.appspot.com",
    messagingSenderId: "xxxxxxxxxx",
    appId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
};
```

こうした情報は原則自分のローカル環境にのみ保存しておき、必要に応じて関係者には1Passwordなど何らかの共有ソフトを用いて知らせるのがベターです。（https://1password.com/jp）  
よってGitHubリポジトリに置くことも良しとされていません。

そこでどう扱うかというと、環境変数を扱うファイル`.env`を作成し、そこに記述して`import`して使うというやり方です。  
また`.gitignore`に`.env`を追記し、Gitでトラックしないように設定します。この方法はJSのに限らず他の言語でも用いられる手法です。

Viteを使ったJSプロジェクトでは下記の3ステップで実行できます。
公式サイトに解説が有るので、これに倣って解説を進めていきます。
https://ja.vitejs.dev/guide/env-and-mode.html

### 1.`.env`ファイルに環境変数を記述する
ルートディレクトリに`.env`ファイルを作成し、対象の環境変数を記述します。
環境変数は`環境変数名=値`というフォーマットで記述します。このとき、下記のルールを確実に守ってください。

1. 環境変数名は英字・大文字で記述し、単語の間はアンダースコア（_）で区切る
2. 文字列の値であってもクォーテーションをつけない
3. 環境変数名・イコール（=）・値の間にはスペースを設けない
4. 環境変数名はプレフィックス`VITE_`をつける（Viteプロジェクト限定）

1~3は守らなくても動作はしますが、慣習としてよく使われるルールのため推奨です。4はViteプロジェクト限定の仕様で、 __守らないと動作しません。__  

```zsh
VITE_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
VITE_AUTH_DOMAIN=daily-report-xxxxx.firebaseapp.com
VITE_PROJECT_ID=daily-report-xxxxx
VITE_STORAGE_BUCKET=daily-report-xxxxx.appspot.com
VITE_MESSAGING_SENDER_ID=xxxxxxxxxx
APP_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 2.`.gitignore`に`.env`を追加
Gitで更新履歴をトラックしないよう、`.gitignore`に`.env`を追記します。`.gitignore`にはすでにたくさん記述があると思いますが、一番下に追記します。

```zsh
...（中略）...

.env
```

### 3.`main.js`を書き換える
最後に、`main.js`の`firebaseConfig`を、`.env`から変数を`import`して書き換えます。  
このプロセスは本来`Dotenv`などのnpmモジュールをインストールしないとできませんが、Viteプロジェクトの場合は`import.meta.env.環境変数名`とすることでとくに何もインストールすることなく利用できます。  
具体的には下記のようにします。

・Before
```js
const firebaseConfig = {
    apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    authDomain: "daily-report-xxxxx.firebaseapp.com",
    projectId: "daily-report-xxxxx",
    storageBucket: "daily-report-xxxxx.appspot.com",
    messagingSenderId: "xxxxxxxxxx",
    appId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
};
```

・After
```js
const firebaseConfig = {
    apiKey: import.meta.env.VITE_API_KEY,
    authDomain: import.meta.env.VITE_AUTH_DOMAIN,
    projectId: import.meta.env.VITE_PROJECT_ID,
    storageBucket: import.meta.env.VITE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.VITE_MESSAGING_SENDER_ID,
    appId: import.meta.env.APP_ID
};
```

![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/product/env.png>)

---

【コラム】
`.env`や`.gitignore`など、名前がドットから始まるファイルやフォルダは不可視ファイルまたは不可視フォルダと呼ばれ、デフォルトの設定ではFinderやエクスプローラー上で表示がされません。  
こうしたファイルやフォルダはシステムの重要な設定を扱う開発者向けのデータである場合がほとんどのため、安易に編集できないようにする必要があるからです。
CursorなどのIDEでは確認ができますが、Finderやエクスプローラーで確認したい場合は下記のように設定を変更してください。

・エクスプローラー（Windows）
[表示] > [表示] > [隠しファイル] を選択

・Finder（macOS）
ショートカットキー「Shift + cmd + .」を入力

---

## 完成形
以上でリファクタリングが完了しました！最終的なコードは下記のとおりです。

・my-modules/fetch-history-data.js
```js
export const fetchHistoryData = async (getDocs, collection, db) => {
    let tags = "";
    
    // reportsコレクションのデータを取得
    const querySnapshot = await getDocs(collection(db, "reports")); 
    
    // データをテーブル表の形式に合わせてHTMLに挿入
    querySnapshot.forEach((doc) => {
      console.log(`${doc.id} => ${doc.data()}`); 
      tags += `<tr><td>${doc.data().date}</td><td>${doc.data().name}</td><td>${doc.data().work}</td><td>${doc.data().comment}</td></tr>`
    });
    document.getElementById("js-history").innerHTML = tags;
};
```

・my-modules/submit-data.js
```js
export const submitData = async (e, addDoc, collection, db) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const docRef = await addDoc(collection(db, "reports"), {
            date: new Date(),
            name: formData.get("name"),
            work: formData.get("work"),
            comment: formData.get("comment")
        });
        console.log("Document written with ID: ", docRef.id);
    } catch (e) {
        console.error("Error adding document: ", e);
    }
}
```

・main.js
```js
import { initializeApp } from "firebase/app";
import { getFirestore, collection, getDocs, addDoc } from "firebase/firestore"; 
import { fetchHistoryData } from "./my-modules/fetch-history-data";
import { submitData } from "./my-modules/submit-data";

// 設定情報
const firebaseConfig = {
    apiKey: import.meta.env.VITE_API_KEY,
    authDomain: import.meta.env.VITE_AUTH_DOMAIN,
    projectId: import.meta.env.VITE_PROJECT_ID,
    storageBucket: import.meta.env.VITE_STORAGE_BUCKET,
    messagingSenderId: import.meta.env.VITE_MESSAGING_SENDER_ID,
    appId: import.meta.env.APP_ID
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Cloud Firestoreの初期化
const db = getFirestore(app);

// Cloud Firestoreから取得したデータを表示する
if(document.getElementById("js-history")) {
    fetchHistoryData(getDocs, collection, db);
}

// Cloud Firestoreにデータを送信する
if(document.getElementById("js-form")) {
    document.getElementById("js-form").addEventListener("submit", (e) => submitData(e, addDoc, collection, db)); 
}
```

・.env
```zsh
VITE_API_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
VITE_AUTH_DOMAIN=daily-report-xxxxx.firebaseapp.com
VITE_PROJECT_ID=daily-report-xxxxx
VITE_STORAGE_BUCKET=daily-report-xxxxx.appspot.com
VITE_MESSAGING_SENDER_ID=xxxxxxxxxx
APP_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```