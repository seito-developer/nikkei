# Cloud Firestoreでのバックエンド実装
さて、Firebaseのセットアップが済んだので、いよいよこのセクションではCloud FirestoreでDBを構築し、アプリケーションと連携させてみましょう。

## Cloud Firestoreのデータ構造
NoSQLであるCloud Firestoreのデータ構造は「コレクション、ドキュメント、データ」のシンプルな3階層から構成されます。
コレクションは複数のドキュメントをまとめる単位で、ドキュメントは複数のデータをまとめることができる単位です。最小単位であるデータは文字列や数字などの要素を指します。

今回の日報アプリの例では、1つ1つの日報の記録＝ドキュメントとなり、データ＝日報の詳細（日時、コメント内容など）となります。
シンプルなアプリケーションなので、コレクションはこれらドキュメントをもつコレクション1つだけが存在する形になります。
（もしこのアプリケーションがもっと複雑で、例えば複数のユーザーや組織に使われることを想定した場合は、それらをまとめるために複数のコレクションが存在することになるでしょう）

![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/document-model.png>)

## Cloud Firestoreでダミーデータを作成する
先の説明でデータ構造の概念自体はなんとなくお伝えできたかと思います。
それを踏まえて、実際にデータがどのように管理されるのか、Cloud Firestoreのダッシュボード上でダミーのデータを作成することで確かめてみましょう。

Cloud Firestoreのコンソール画面で「コレクションを開始」をクリックします。
![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/database/firebase-5.png>)

「コレクション ID」に`reports`と入力し、「次へ」ボタンをクリックします。

![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/database/firebase-6.png>)

「ドキュメント ID」に、「自動ID」をクリックしてランダムな値を入力します。
![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/database/firebase-7.png>)

フィールドにはまず「フィールドを追加」を押して合計4つの入力欄を用意してください。
その上で下記を設定します。

- フィールド：date, タイプ：timestamp、値：2024年1月1日 19:00:00
- フィールド：name, タイプ：string、値：山田太郎
- フィールド：work, タイプ：string、値：コーディング
- フィールド：comment, タイプ：string、値：ログイン機能の作成

これはつまり、山田太郎さんという社員がコーディングの業務（ログイン機能の作成）を2024年1月1日に行ったことを意味する日報のダミー記録です。

入力が完了したら「保存」ボタンをクリックします。
![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/database/firebase-8.png>)

するとデータベース上に入力したコレクション、ドキュメント、データが反映されます。
いかがでしょうか？先程は概念だけを一旦説明してみましたが、コレクション、ドキュメント、データが実際にはどのようにデータベース上で扱われるのか、より具体的におわかりいただけたのではないでしょうか。

これだけではまだデータベース上にデータが存在しているだけで、Webページとは繋がっていません。
そこで次はいよいよ、JSを使ってこのデータベースとWebアプリケーションを連携させ、データの送信〜保存や取得〜表示までを行って見たいと思います。

## データの取得・表示
まずCloud Firestoreからデータを取得し、Webページに表示させる機能を実装してみましょう。
公式サイトにCloud Firestoreの説明書ページがあるので、この情報と元にコーディングを進めていきます。
https://firebase.google.com/docs/firestore/quickstart?hl=ja

Chapter 7.7ですでに`main.js`に下記のコードを追記しているかと思います。

<!-- TODO: 行数見直し -->

```js
1 import { initializeApp } from "firebase/app";
2 
3 // 設定情報
4 const firebaseConfig = {
5     apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
6     authDomain: "daily-report-xxxxx.firebaseapp.com",
7     projectId: "daily-report-xxxxx",
8     storageBucket: "daily-report-xxxxx.appspot.com",
9     messagingSenderId: "xxxxxxxxxx",
10    appId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
11 };
12
13 // Initialize Firebase
14 const app = initializeApp(firebaseConfig);
```

この後、まずはCloud Firestoreの利用に必要なモジュールをimportすべく、2行目に下記を追記します。

Before
```js
1 import { initializeApp } from "firebase/app";
```

After
```js
1 import { initializeApp } from "firebase/app";
2 import { getFirestore, collection, getDocs } from "firebase/firestore"; 
```

加えて、この17行目以降に下記のコードを追記しましょう。
  
```js
1 // Cloud Firestoreの初期化
2 const db = getFirestore(app);
3 
4 // Cloud Firestoreから取得したデータを表示する
5 const fetchHistoryData = async () => {
6     let tags = "";
7   
8     // reportsコレクションのデータを取得
9     const querySnapshot = await getDocs(collection(db, "reports")); 
10   
11    // データをテーブル表の形式に合わせてHTMLに挿入
12    querySnapshot.forEach((doc) => {
13        console.log(`${doc.id} => ${doc.data()}`); 
14        tags += `<tr><td>${doc.data().date}</td><td>${doc.data().name}</td><td>${doc.data().work}</td><td>${doc.data().comment}</td></tr>`
15    });
16    document.getElementById("js-history").innerHTML = tags;
17 };
18 
19 // Cloud Firestoreから取得したデータを表示する
20 if(document.getElementById("js-history")) {
21    fetchHistoryData();
22 }
```

まず、1~2行目ではCloud Firestoreを初期化しています。17行目ではFirebase自体の初期化を行いましたが、これとは別に初めに必要な手続きです。

次に5~17行目では、非同期の関数`fetchHistoryData`を定義しています。この中ではChapter 5.14で解説した`async/await`構文が使われています。

9行目では、Firebaseモジュールの`getDocs`メソッドを使って`reports`コレクションのデータを取得し、変数`querySnapshot`に格納しています。
`getDocs`は引数にコレクションを指定することで、そのコレクションに紐づいたドキュメントを取得することができるメソッドです。

```js
getDocs(対象のコレクション)
```

また非同期で処理されるため、`async`で宣言された関数内であれば`await`をつけて実行が可能です。（Chapter 5.14参照）
以降のコードでは受け取ったデータを表組みのレイアウトに合わせて挿入する命令を書いていますが、この処理はデータの取得が確実に完了してからでないと実行できない（エラーになる）ので、`await`で待機させます。

また、コレクションの指定には同じくFirebaseモジュールの`collection`メソッドを使います。これは第１引数に初期化されたCloud Firestoreのオブジェクト、第２引数にコレクション名を設定することで、そのコレクションを指定することができます。

```js
collection(Cloud Firestoreのオブジェクト, コレクション名）
```

初期化されたCloud Firestoreのオブジェクトは2行目で定義した`db`、コレクション名は先程ダッシュボードで設定した`reports`なので、`collection(db, "reports")`とすることで、`reports`コレクションを指定しています。

30~33行目では、Cloud FirestoreのDBから取得したデータをテーブル表の形式に合わせたHTMLタグに合わせた上で、24行目で定義した空の変数`tags`にデータの数だけ代入しています。
ここで使われている`forEach`構文はループ文の一種で、`配列.forEach((配列から取り出した1要素) => {処理})`の形で使用し、配列から順に値を取り出すことが出来ます。  
これはES6以降２登場した比較的新しい書き方で、for文よりも簡潔に書くことができるのが特徴です。ちなみにfor文で書き直すと下記のようになります。  

```js
for (let index = 0; index < querySnapshot.docs.length; index++) {
    const doc = querySnapshot.docs[index];
    console.log(`${doc.id} => ${doc.data()}`); 
    tags += `<tr><td>${doc.data().date}</td><td>${doc.data().name}</td><td>${doc.data().work}</td><td>${doc.data().comment}</td></tr>`
}
```

Cloud Firestoreに登録したデータはイメージ下記のような配列だと思ってください。これを`forEach`構文でループし取り出しているのです。

```js
const docs = [
    {
        date: "2024年1月5日 19:00:00 UTC+9",
        name: "山田太郎",
        comment: "ログイン機能の作成",
        work: "コーディング"
    }, 
    { ... },
    { ... }
];
```

また、20~22行目では`#js-history`要素がWebページ上にあるときのみ`fetchHistoryData`を実行する、という処理を記述します。  
`index.html`のように`#js-history`要素がないページで`fetchHistoryData`を実行すると、`document.getElementById("js-history")`の処理が走ってしまい`#js-history`が見つからずエラーになってしまうので、要素がない場合は実行しないようにすることでこれを回避します。

ここまで実装が終わったら、下記のようにhistory.html上にはCloud Firestoreから取得したデータが表示されるはずです！

![Alt text](<../Chapter 5.JavaScriptでプログラミング言語の基礎を学ぼう！/images/history.html.png>)

## データの取得・表示
では続いて`index.html`にてフォームからデータを送信し、Cloud Firestoreに保存する機能を実装してみましょう。
まずはデータ送信に必要なメソッド`addDoc`をCloud Firestoreモジュールからimportすべく、2行目に下記を追記します。

```js
2 import { getFirestore, collection, getDocs, addDoc } from "firebase/firestore"; 
```

加えて、この36行目以降に下記のコードを追記しましょう。

```js
1 // Cloud Firestoreにデータを送信する
2 const submitData = async (e) => {
3     e.preventDefault();
4
5     const formData = new FormData(e.target);
6   
7     try {
8         const docRef = await addDoc(collection(db, "reports"), {
9             date: new Date(),
10            name: formData.get("name"),
11            work: formData.get("work"),
12            comment: formData.get("comment")
13        });
14        console.log("Document written with ID: ", docRef.id);
15    } catch (e) {
16        console.error("Error adding document: ", e);
17    }
18 }
19 // Cloud Firestoreにデータを送信する
20 if(document.getElementById("js-form")) {
21    document.getElementById("js-form").addEventListener("submit", (e) => submitData(e));
22 }
```

まずこのコードは大きく分けると1~18行目で関数`submitData`を定義し、19行目ではフォームの送信イベントが呼ばれたとき（送信ボタンがクリックされたとき）にこれを実行するように設定しています。

3行目では受け取ったイベントオブジェクトに対し、`preventDefault`メソッドを実行しています。このメソッドを使うとイベントをキャンセルすることができます。  
デフォルトのHTML,JSでは、送信イベントが呼ばれるとページがリロードされたり繊維したりするのですが、今回はそれをキャンセルしています。例えばお問合せフォームのように、データ送信後に完了ページへ遷移させたい場合などはその仕様でかまいませんが、今回ページの遷移・リロードは不要です。

5行目では入力したフォームの値を取得するために、`FormData`オブジェクトを生成しています。これはフォームの値を取得するためのオブジェクトで、`new FormData(フォーム要素)`の形で使います。  
その後10~12行目では`FormData`オブジェクトに対し`get`メソッドが呼ばれていますが、これは引数にkey名を渡すことで、そのkeyに対応する値を取得することができます。  
key名は`<input>`や`<textarea>`タグに設定されたname属性の値になります。  
例えば`<input class="input-field" type="text" id="name" name="name">`からは、`formData.get("name")`とすることで入力された値を取得することができます。

7~17行目ではまず全体を`try/catch`構文で囲っており、`try`の中で実行した処理にエラーが発生した場合に`catch`の中の処理が実行されるようになっています。(Chapter 5.14参照)  
`try`の中、9行目ではFirebaseモジュールの`addDoc`メソッドが呼ばれています。
`addDoc`はコレクションに対し新規のドキュメントを非同期で作成できるメソッドで、第１引数に対象のコレクション、第２引数にドキュメントに含めるデータを設定します。 

```js
addDoc(対象のコレクション, ドキュメントに含めるデータ）
```

コレクションの指定には先程のデータを取得する際に組んだコードと同じく、`collection`メソッドを使います。
第2引数にはドキュメントに含めるデータをオブジェクト形式で設定します。`name`, `work`, `comment`には先程の`FormData`オブジェクトを通じてユーザーが入力した値を渡しており、`date`には`Date`オブジェクトで送信時の日時データを設定しています。これは現在時刻を取得するメソッドで、日報の日付を自動で設定するために使っています。（Chapter 5.10参照）

14行目はドキュメント作成が成功した際に作成されたドキュメントのIDをコンソール上に表示する処理で, 16行目は失敗した際の情報をコンソール上に表示する処理です。なくても成立する部分ですが、デバッグ用に利用できます。

また、20~22行目ではデータの取得・表示のコード同様、 `#js-form`要素がWebページ上にあるときのみ実行する、という処理を記述します。  

ここまで実装できたら、実際にフォームから値を入力して動作確認してみましょう！  
成功した場合、下記のように履歴ページでリロードしたらデータが追加されているはずです。またダッシュボード上でもドキュメントが追加されているのが確認できます。

![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/product/complete-1.png>) ![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/product/complete-2.png>) ![Alt text](<../Chapter 7.実演・サーバーサイド・プログラム/images/firebase/product/complete-3.png>)

ここまでの`main.js`の全コードは下記のとおりです。

```js
import { initializeApp } from "firebase/app";
import { getFirestore, collection, getDocs, addDoc } from "firebase/firestore"; 

// 設定情報
const firebaseConfig = {
    apiKey: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    authDomain: "daily-report-xxxxx.firebaseapp.com",
    projectId: "daily-report-xxxxx",
    storageBucket: "daily-report-xxxxx.appspot.com",
    messagingSenderId: "xxxxxxxxxx",
    appId: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Cloud Firestoreの初期化
const db = getFirestore(app);

// Cloud Firestoreから取得したデータを表示する
const fetchHistoryData = async () => {
    let tags = "";
  
    // reportsコレクションのデータを取得
    const querySnapshot = await getDocs(collection(db, "reports")); 
  
    // データをテーブル表の形式に合わせてHTMLに挿入
    querySnapshot.forEach((doc) => {
        console.log(`${doc.id} => ${doc.data()}`); 
        tags += `<tr><td>${doc.data().date}</td><td>${doc.data().name}</td><td>${doc.data().work}</td><td>${doc.data().comment}</td></tr>`
    });
    document.getElementById("js-history").innerHTML = tags;
};

// Cloud Firestoreから取得したデータを表示する
if(document.getElementById("js-history")) {
    fetchHistoryData(getDocs, collection, db);
}

// Cloud Firestoreにデータを送信する
const submitData = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
  
  try {
      const docRef = await addDoc(collection(db, "reports"), {
          date: new Date(),
          name: formData.get("name"),
          work: formData.get("work"),
          comment: formData.get("comment")
      });
      console.log("Document written with ID: ", docRef.id);
  } catch (e) {
      console.error("Error adding document: ", e);
  }
}

// Cloud Firestoreにデータを送信する
if(document.getElementById("js-form")) {
    document.getElementById("js-form").addEventListener("submit", (e) => submitData(e, addDoc, collection, db)); 
}
```